# ============================================================================
# Doctor AI - Render Blueprint (100% FREE Deployment)
# ============================================================================
# This blueprint deploys the complete Doctor AI Medical Symptom Mapper stack
# entirely for FREE using Render's free tier + external free services.
#
# What gets deployed on Render (FREE):
# - Backend API (FastAPI + ML models) - FREE tier
# - Frontend (React + Vite) - FREE static hosting
#
# External FREE services you'll need to set up (5 minutes):
# - PostgreSQL Database: Neon.tech (FREE 3GB) or Supabase (FREE 500MB)
# - Qdrant Vector DB: Qdrant Cloud (FREE 1GB) - Optional
# - Redis Cache: Upstash (FREE 10K req/day) - Optional
#
# Quick Start (FREE Deployment):
# 1. Fork/push this repo to GitHub
# 2. Go to https://render.com/dashboard
# 3. Click "New" â†’ "Blueprint"
# 4. Connect your repository and click "Apply"
# 5. Sign up for free database at https://neon.tech/
# 6. Add DATABASE_URL to backend environment in Render
# 7. Done! Your app is running 100% FREE ðŸŽ‰
#
# Total Cost: $0/month (FREE tier with limitations)
#
# Limitations:
# - Services spin down after 15 min inactivity (30-60s wake up time)
# - 512MB RAM (may struggle with large ML models)
# - Perfect for demos, testing, and personal projects
#
# Documentation: See RENDER_DEPLOYMENT.md for detailed instructions
# ============================================================================

services:
  # ==========================================================================
  # Backend API Service
  # ==========================================================================
  # FastAPI application with ML/NLP capabilities for medical diagnosis
  # Includes BioBERT embeddings and symptom constellation mapping
  # ==========================================================================
  - type: web
    name: doctor-ai-backend
    runtime: python
    region: oregon
    plan: free  # Free tier with limitations (512MB RAM, spins down after 15 min inactivity)
    branch: main

    # Build Configuration
    buildCommand: |
      pip install --upgrade pip
      pip install -r requirements.txt

    # Start Command
    startCommand: |
      alembic upgrade head
      uvicorn src.main:app --host 0.0.0.0 --port $PORT --workers 1

    # Health Check
    healthCheckPath: /api/v1/monitoring/health

    # Auto-deploy
    autoDeploy: true

    # Environment Variables
    envVars:
      # ===== Application Configuration =====
      - key: APP_NAME
        value: Medical Symptom Constellation Mapper

      - key: APP_VERSION
        value: 0.2.0

      - key: DEBUG
        value: false

      - key: LOG_LEVEL
        value: INFO

      # ===== API Configuration =====
      - key: API_HOST
        value: 0.0.0.0

      - key: API_PORT
        value: 10000

      - key: API_PREFIX
        value: /api/v1

      # ===== Security Configuration =====
      # Auto-generate a secure random secret key
      - key: SECRET_KEY
        generateValue: true

      - key: ALGORITHM
        value: HS256

      - key: ACCESS_TOKEN_EXPIRE_MINUTES
        value: 30

      # ===== CORS Configuration =====
      # IMPORTANT: Update this after deploying frontend to include your frontend URL
      - key: CORS_ORIGINS
        value: https://doctor-ai-frontend.onrender.com,http://localhost:3000

      - key: CORS_ALLOW_CREDENTIALS
        value: true

      # ===== Rate Limiting =====
      - key: RATE_LIMIT_ENABLED
        value: true

      - key: RATE_LIMIT_REQUESTS
        value: 100

      - key: RATE_LIMIT_PERIOD
        value: 60

      # ===== Database Configuration =====
      # IMPORTANT: Add your free database URL from one of these providers:
      # - Neon: https://neon.tech/ (Free tier: 3GB storage)
      # - Supabase: https://supabase.com/ (Free tier: 500MB database)
      # - ElephantSQL: https://www.elephantsql.com/ (Free tier: 20MB)
      # - Render PostgreSQL: https://render.com (Paid: starts at $7/month)
      # Format: postgresql://username:password@host:port/database
      - key: DATABASE_URL
        sync: false  # Must be added manually in Render dashboard

      - key: DATABASE_ECHO
        value: false

      # ===== Qdrant Vector Database =====
      # NOTE: Qdrant requires a private service or Qdrant Cloud
      # For production: Sign up at https://cloud.qdrant.io/
      # For demo: These settings will disable vector search features
      - key: QDRANT_HOST
        value: localhost

      - key: QDRANT_PORT
        value: 6333

      - key: QDRANT_API_KEY
        sync: false

      - key: QDRANT_COLLECTION_NAME
        value: medical_conditions

      # ===== Redis Cache =====
      # NOTE: Redis requires a private service or Redis Cloud
      # For production: Sign up at https://redis.com/cloud/overview/
      # For demo: These settings will disable caching
      - key: REDIS_HOST
        value: localhost

      - key: REDIS_PORT
        value: 6379

      - key: REDIS_DB
        value: 0

      - key: REDIS_PASSWORD
        sync: false

      # ===== ML/NLP Models =====
      # BioBERT model for medical text embeddings (~420MB download)
      - key: EMBEDDING_MODEL
        value: microsoft/BiomedNLP-PubMedBERT-base-uncased-abstract-fulltext

      - key: EMBEDDING_DIMENSION
        value: 768

      - key: MAX_SEQUENCE_LENGTH
        value: 512

      # ===== AI Assistant Configuration =====
      # REQUIRED: Add your OpenAI API key for AI assistant features
      # Get your key at: https://platform.openai.com/api-keys
      - key: OPENAI_API_KEY
        sync: false  # Must be added manually in Render dashboard

      - key: USE_LOCAL_LLM
        value: false

      - key: LOCAL_LLM_MODEL
        value: llama2

      # ===== Medical Ontology Configuration =====
      - key: USE_SNOMED_CT
        value: true

      - key: USE_ICD10
        value: true

      - key: USE_HPO
        value: true

      # ===== Confidence Thresholds =====
      # Adjust these based on your accuracy requirements
      - key: TIER1_CONFIDENCE_THRESHOLD
        value: 0.85

      - key: TIER2_CONFIDENCE_THRESHOLD
        value: 0.60

      - key: TIER3_CONFIDENCE_THRESHOLD
        value: 0.40

      # ===== Search Parameters =====
      - key: TOP_K_CANDIDATES
        value: 50

      - key: FINAL_RESULTS_LIMIT
        value: 10

      # ===== HIPAA Compliance =====
      - key: ENABLE_AUDIT_LOGGING
        value: true

      - key: ENABLE_DATA_ANONYMIZATION
        value: true

      - key: AUDIT_LOG_PATH
        value: /var/data/logs/audit/

      # ===== Feature Flags =====
      - key: ENABLE_RARE_DISEASE_DETECTION
        value: true

      - key: ENABLE_RED_FLAG_ALERTS
        value: true

      - key: ENABLE_TEMPORAL_ANALYSIS
        value: true

      - key: ENABLE_AI_ASSISTANT
        value: true

  # ==========================================================================
  # Frontend Service
  # ==========================================================================
  # React + Vite static site with responsive UI
  # Serves the web interface for symptom analysis and diagnosis
  # ==========================================================================
  - type: web
    name: doctor-ai-frontend
    runtime: static
    branch: main

    # Build Configuration
    buildCommand: |
      cd frontend
      npm ci
      npm run build

    # Static site configuration
    staticPublishPath: frontend/dist

    # Auto-deploy
    autoDeploy: true

    # Route Configuration
    # Handle React Router by rewriting all routes to index.html
    routes:
      - type: rewrite
        source: /*
        destination: /index.html

    # Pull request previews
    pullRequestPreviewsEnabled: true

    # Environment Variables
    envVars:
      # API URL - automatically set to the backend service URL
      - key: VITE_API_URL
        fromService:
          type: web
          name: doctor-ai-backend
          envVarKey: RENDER_EXTERNAL_URL

# ============================================================================
# External Services (Required for FREE Deployment)
# ============================================================================
# For a completely FREE deployment, you need to set up these external services:
#
# 1. PostgreSQL Database (REQUIRED) - Choose one FREE option:
#    - Neon (RECOMMENDED) - https://neon.tech/
#      * Free tier: 3GB storage, 1 project
#      * Serverless PostgreSQL, no cold starts
#      * Sign up â†’ Create project â†’ Copy connection string
#
#    - Supabase - https://supabase.com/
#      * Free tier: 500MB database, 2GB bandwidth
#      * Includes auth, storage, and realtime features
#      * Sign up â†’ Create project â†’ Get DATABASE_URL
#
#    - ElephantSQL - https://www.elephantsql.com/
#      * Free tier: 20MB storage (limited but works for testing)
#      * Easy setup, reliable
#      * Sign up â†’ Create instance â†’ Copy URL
#
#    After getting your database URL, add it to backend environment:
#    DATABASE_URL = postgresql://username:password@host:port/database
#
# 2. Qdrant Vector Database (OPTIONAL - for semantic search)
#    - Qdrant Cloud - https://cloud.qdrant.io/
#      * Free tier: 1GB storage, 100K vectors
#      * Add QDRANT_HOST and QDRANT_API_KEY to backend env vars
#
# 3. Redis Cache (OPTIONAL - for performance)
#    - Upstash Redis - https://upstash.com/
#      * Free tier: 10K requests/day, 256MB storage
#      * Add REDIS_HOST, REDIS_PORT, REDIS_PASSWORD to backend env vars
#
#    - Redis Cloud - https://redis.com/cloud/overview/
#      * Free tier: 30MB
#
# 4. OpenAI API (OPTIONAL - for AI assistant features)
#    - Sign up: https://platform.openai.com/
#    - Add OPENAI_API_KEY to backend env vars
#    - Note: OpenAI charges per usage (not subscription)
#
# ============================================================================

# ============================================================================
# Post-Deployment Steps (For FREE Setup)
# ============================================================================
# After deploying this blueprint:
#
# 1. âœ… Set up a FREE PostgreSQL database (REQUIRED)
#    - Go to Neon.tech (recommended) or Supabase/ElephantSQL
#    - Sign up for free account
#    - Create a new database/project
#    - Copy the connection string (DATABASE_URL)
#    - In Render dashboard:
#      * Go to doctor-ai-backend â†’ Environment
#      * Add: DATABASE_URL = your-postgresql-connection-string
#    - Redeploy the backend service
#
# 2. âœ… Update CORS_ORIGINS with your frontend URL
#    - Wait for frontend to deploy
#    - Copy the frontend URL (e.g., https://doctor-ai-frontend.onrender.com)
#    - Go to backend â†’ Environment
#    - Update CORS_ORIGINS to include your frontend URL
#    - Redeploy backend
#
# 3. âœ… (Optional) Add OPENAI_API_KEY for AI assistant features
#    - Get API key from https://platform.openai.com/
#    - Add: OPENAI_API_KEY = your-key-here
#
# 4. âœ… (Optional) Set up Qdrant Cloud FREE tier for vector search
#    - Sign up at https://cloud.qdrant.io/ (free tier available)
#    - Create a cluster
#    - Add QDRANT_HOST and QDRANT_API_KEY to backend
#
# 5. âœ… (Optional) Set up Upstash Redis FREE tier for caching
#    - Sign up at https://upstash.com/ (free tier available)
#    - Create a database
#    - Add REDIS_HOST, REDIS_PORT, REDIS_PASSWORD to backend
#
# 6. âœ… Test your deployment
#    - Backend health: https://your-backend.onrender.com/api/v1/monitoring/health
#    - API docs: https://your-backend.onrender.com/docs
#    - Frontend: https://your-frontend.onrender.com
#    - Dashboard: https://your-frontend.onrender.com/dashboard
#
# 7. âœ… Monitor your application
#    - Check logs in Render dashboard
#    - Monitor metrics at /api/v1/monitoring/metrics
#    - Review dashboard analytics
#
# Note: Free tier services spin down after 15 minutes of inactivity.
# First request after inactivity may take 30-60 seconds to wake up.
#
# ============================================================================

# ============================================================================
# Cost Estimate
# ============================================================================
#
# ðŸ†“ FREE Setup (Recommended for Testing/Personal Projects):
# - Render Backend (Free):     FREE (with limitations)
# - Render Frontend:           FREE
# - Neon PostgreSQL:           FREE (3GB storage)
# - Qdrant Cloud:              FREE (optional, 1GB)
# - Upstash Redis:             FREE (optional, 10K req/day)
# - Total:                     $0/month ðŸŽ‰
#
# Limitations of FREE tier:
# - Services spin down after 15 min inactivity (30-60s cold start)
# - 512MB RAM (may struggle with large ML models)
# - Limited build minutes
# - Suitable for demos, testing, and low-traffic apps
#
# Minimal Paid Setup (Demo/Small Production):
# - Render Backend Starter:    $7/month (no cold starts, more reliable)
# - Render Frontend:           FREE
# - Neon/Supabase DB:          FREE or $7/month for more storage
# - Total:                     $7-14/month
#
# Recommended Production Setup:
# - Render Backend Standard:   $25/month (2GB RAM for ML models)
# - Render Frontend:           FREE
# - PostgreSQL (paid):         $20/month (more storage/backups)
# - Qdrant Cloud Starter:      $25/month (optional)
# - Redis Cloud Starter:       $5/month (optional)
# - Total:                     ~$45-75/month
#
# Enterprise Setup:
# - Render Backend Pro:        $85/month (4GB+ RAM)
# - Render Frontend:           FREE
# - PostgreSQL Pro:            $90/month
# - Qdrant Cloud Growth:       $95/month
# - Redis Cloud Pro:           $15/month
# - Total:                     ~$285/month
#
# ============================================================================

# ============================================================================
# Troubleshooting
# ============================================================================
#
# Service is slow / times out:
# - FREE tier services sleep after 15 min inactivity
# - First request takes 30-60 seconds to wake up
# - Solution: Upgrade to paid plan ($7/month) for no cold starts
# - Or: Use a service like UptimeRobot to ping your app every 14 min
#
# Service won't start / DATABASE_URL error:
# - Make sure you added DATABASE_URL to backend environment variables
# - Get free database from Neon.tech, Supabase, or ElephantSQL
# - Check the connection string format: postgresql://user:pass@host:port/db
# - Review logs in Render dashboard for specific errors
#
# Frontend can't connect to backend:
# - Verify VITE_API_URL is set correctly (should auto-populate)
# - Check CORS_ORIGINS includes your frontend URL
# - Test backend health endpoint directly
# - Wait for services to wake up if on free tier
#
# ML model errors / Out of memory:
# - Free tier has only 512MB RAM (BioBERT model needs ~420MB)
# - May fail with large requests or multiple simultaneous users
# - Solution: Upgrade to Starter ($7/month) or Standard plan ($25/month)
# - Or: Use lighter embedding models
#
# Database connection issues:
# - Verify DATABASE_URL is correct in Render dashboard
# - Check external database service (Neon/Supabase) is running
# - Ensure database allows external connections
# - Review database credentials and host
#
# Build fails:
# - Free tier has limited build minutes
# - Check requirements.txt for conflicting dependencies
# - Review build logs in Render dashboard
#
# For more help:
# - Documentation: See RENDER_DEPLOYMENT.md
# - Render Docs: https://render.com/docs
# - Community: https://community.render.com
# - Neon Docs: https://neon.tech/docs
#
# ============================================================================
